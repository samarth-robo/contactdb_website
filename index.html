<!DOCTYPE html>
<html lang="en">
	<head>
		<title>ContactDB Explorer</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css"
      integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">    
    <style>
      body, html, .container {
        height: 100%;
      }
    </style>
	</head>
	<body>
    <script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>
		<script src="js/three.min.js"></script>
		<script src="js/PLYLoader.js"></script>
		<script src="js/WebGL.js"></script>
    <script src="js/TrackballControls.js"></script>

    <div class="container">
      <div class="row">
        <div class="col">
          <h1>ContactDB: Analyzing and Predicting Grasp Contact via Thermal Imaging</h1>
          <h2 id="advisors">
            <a href="https://samarth-robo.github.io/" target="_blank">Samarth Brahmbhatt</a>,
            <a href="https://cusuh.github.io/" target="_blank">Cusuh Ham</a>,
          </h2>
          <h2>Georgia Tech Robotics</h2>
          ContactDB is a dataset of contact maps for household objects. Objects are grasped by human participants with two post-grasp functional intents: 'use' and 'handoff'.
        </div>
      </div>

      <div class="row justify-content-around">
        <div class="col">
          Select post-grasp intent: 
          <select id="instructionsMenu" onchange="instructionChanged(this.value)"></select>
        </div>
        <div class="col">
          Select participant: 
          <select id="sessionNamesMenu" onchange="sessionNameChanged(this.value)"></select>
        </div>
        <div class="col" id="displayStatus"></div>
      </div>
      <div class="row h-50">
        <div class="col h-100">
          <canvas class="border w-100 h-100"></canvas>
        </div>
      </div>
      <div class="row">
        <div class="col">
          <div class="row justify-content-around btn-group btn-group-toggle flex-wrap" id="thumbArea" data-toggle="buttons"></div>
        </div>
      </div>
      <footer>
        <script>
          var d = new Date();
          document.write('<p>&copy; Samarth Brahmbhatt ' + d.getFullYear() + ', website created using <a href="http://getbootstrap.com/" target="_blank">Bootstrap</a>.</p>')
        </script>
      </footer>
    </div>

		<script>

			if ( WEBGL.isWebGLAvailable() === false ) {

				document.body.appendChild( WEBGL.getWebGLErrorMessage() );

			}

			var camera, scene, renderer, controls, dLight, aLight, material, mesh, loader, meshName;
      var objectName, sessionName, instruction;
      var datapoints;
      var thumbnailHeight = 40;
      var DEV = false;

			init();

      function updateObjectNames() {
        // update the object names menu
        var thumbArea = document.getElementById("thumbArea");
        thumbArea.innerHTML = "";
        var selectedObject = Object.keys(datapoints[instruction])[0];
        for (var o in datapoints[instruction]) {
          if (o == objectName) {
            selectedObject = o;
          }
          var imgName;
          if (DEV) {
            imgName = 'http://cayley.cc.gt.atl.ga.us/contactdb_dataset/thumbnails/' + o + '.png';
            // imgName = './thumbnails/' + o + '.png';
          } else {
            imgName = '../thumbnails/' + o + '.png';
          }
          var img = document.createElement("img");
          img.src = imgName;
          img.height = thumbnailHeight;
          var inp = document.createElement("input");
          inp.type = "radio";
          inp.name = "objectNameOptions";
          inp.value = o;
          inp.id = o + "Button";
          inp.autocomplete = "off";
          inp.setAttribute("onchange", "objectNameChanged(this.value)");
          var label = document.createElement("label");
          label.className = "btn btn-outline-primary";
          label.setAttribute("data-toggle", "tooltip");
          label.setAttribute("title", o);
          label.appendChild(inp);
          label.appendChild(img);
          thumbArea.appendChild(label);
        }
        $('[data-toggle="tooltip"]').tooltip();
        document.getElementById(selectedObject + "Button").click();
      }

      
      function updateSessionNames() {
        // update the session names menu
        var menu = document.getElementById("sessionNamesMenu");
        var prevSessionName = menu.value;
        menu.options.length = 0;
        var idxSelected = 0;
        var sessionList = datapoints[instruction][objectName]
        for (var sIdx=0; sIdx < sessionList.length; sIdx++) {
          var s = sessionList[sIdx];
          menu.options[menu.length] = new Option(s, s);
          if (s == prevSessionName) {
            idxSelected = menu.length - 1;
          }
        }
        menu.options[idxSelected].selected = true;
        menu.onchange(menu.value);
      }


      function updateMenus(instructionSelected, objectNameSelected) {
        if (instructionSelected) {
          updateObjectNames();
        } else if (objectNameSelected) {
          updateSessionNames();
        }
      }


      function instructionChanged(value) {
        instruction = value;
        updateMenus(true, false);
        updateMesh();
      }
      function objectNameChanged(value) {
        objectName = value;
        updateMenus(false, true);
        updateMesh();
      }
      function sessionNameChanged(value) {
        sessionName = value;
        updateMesh();
      }

      
      function updateMesh() {
        var newMeshName;
        if (DEV) {
          newMeshName = 'http://cayley.cc.gt.atl.ga.us/contactdb_dataset/meshes/full' + sessionName + '_' + instruction + '_' + objectName + '.ply';
          // newMeshName = './ps_controller_textured.ply'
        } else {
          newMeshName = '../meshes/full' + sessionName + '_' + instruction + '_' + objectName + '.ply';
        }
        var dispStatus = document.getElementById("displayStatus");
        dispStatus.innerHTML = "Status: <font color='red'>Loading</font>";
        if (newMeshName != meshName) {
          meshName = newMeshName;
          loader.load(meshName, onGeometryLoad);
        }
      }


      function createMenus(jsondata) {
        datapoints = {};
        for (var instr in jsondata) {
          datapoints[instr] = {};
          Object.keys(jsondata[instr]).sort().forEach(function(key) {
            datapoints[instr][key] = jsondata[instr][key];
          });
        }
        
        iMenu = document.getElementById('instructionsMenu');
        
        for (var instr in datapoints) {
          iMenu.options[iMenu.length] = new Option(instr);
        }
        iMenu.options[0].selected = true;
        
        initRender();
        iMenu.onchange(iMenu.value);
        animate();
      }

      
      function initRender() {
				renderer = new THREE.WebGLRenderer( { antialias: true, canvas: document.querySelector("canvas") } );

				camera = new THREE.PerspectiveCamera(60, 2, 0.01, 0.31);
				camera.position.set(0, -0.16, 0.1);
				var cameraTarget = new THREE.Vector3(0, 0, 0);
        camera.lookAt(cameraTarget);

				scene = new THREE.Scene();
				scene.background = new THREE.Color( 0xFFFFFF );

				loader = new THREE.PLYLoader();

				// Lights
        dLight = new THREE.DirectionalLight(0xFFFFFF, 0.5);
        dLight.position.copy(camera.position);
        scene.add(dLight);

        aLight = new THREE.AmbientLight(0xFFFFFF, 0.77);
        scene.add(aLight);

        controls = new THREE.TrackballControls(camera, renderer.domElement);
        controls.rotateSpeed = 5.0;
        controls.addEventListener('change', render);

        material = new THREE.MeshStandardMaterial( { color: 'white', vertexColors: THREE.VertexColors } );
      }

			function init() {
        // randomly sample the order of advisors
        var advisors = document.getElementById("advisors");
        var a0 = document.createElement("a")
        a0.href = "https://www.cc.gatech.edu/~hays/"
        a0.target = "_blank"
        a0.innerText = "James Hays"
        var a1 = document.createElement("a")
        a1.href = "http://ckemp.bme.gatech.edu/"
        a1.target = "_blank"
        a1.innerText = "Charlie Kemp"
        if (Math.random() > 0.5) {
          advisors.appendChild(a0);
          advisors.innerHTML += ", "
          advisors.appendChild(a1);
        } else {
          advisors.appendChild(a1);
          advisors.innerHTML += ", "
          advisors.appendChild(a0);
        }

        // read datapoints information and create dropdown menus
        var datapointsName;
        if (DEV) {
          datapointsName = 'http://cayley.cc.gt.atl.ga.us/contactdb_dataset/datapoints.json';
          // datapointsName = './datapoints.json';
        } else {
          datapointsName = '../datapoints.json';
        }
        $.getJSON(datapointsName, {}, createMenus);

			}

      function onGeometryLoad ( geometry ) {
        geometry.center();
        geometry.computeFaceNormals();
        geometry.computeVertexNormals();

        if (mesh == null) {
          mesh = new THREE.Mesh( geometry, material );
          mesh.name = 'object';
          scene.add(mesh);
        } else {
          mesh.geometry.dispose()
          mesh.geometry = geometry;
        }
        var dispStatus = document.getElementById("displayStatus");
        dispStatus.innerHTML = "Status: Loaded <font color='green'>" + objectName + ", " + instruction + ", #" + sessionName + "</font>";
      }

      function resizeCanvasToDisplaySize() {
        const canvas = renderer.domElement;
        const width = canvas.clientWidth;
        const height = canvas.clientHeight;
        if (canvas.width !== width ||canvas.height !== height) {
          // you must pass false here or three.js sadly fights the browser
          renderer.setSize(width, height, false);
          camera.aspect = width / height;
          camera.updateProjectionMatrix();

          // set render target sizes here
        }
      }

      function render() {
        dLight.position.copy(camera.position);
				renderer.render( scene, camera );
      }

      function animate() {
        resizeCanvasToDisplaySize();
        controls.update();
        render();
				requestAnimationFrame( animate );
			}


		</script>
	</body>
</html>
